name: Update RSS

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug fetch SAIH (headers)
        run: |
          curl -I -L "https://www.redhidrosurmedioambiente.es/saih/resumen/rios" || true

      - name: Debug fetch SAIH (html + scripts + table sniff)
        run: |
          set -e
          URL="https://www.redhidrosurmedioambiente.es/saih/resumen/rios"

          echo "---- DESCARGA HTML ----"
          curl -L "$URL" -o /tmp/saih.html
          ls -lh /tmp/saih.html
          wc -c /tmp/saih.html

          echo "---- BUSCAR TABLA / PALABRAS CLAVE EN HTML ----"
          echo "Conteo <table>:"
          grep -o "<table" /tmp/saih.html | wc -l || true
          echo "Conteo <tr>:"
          grep -o "<tr" /tmp/saih.html | wc -l || true
          echo "Buscar palabras: NIVEL / medio / estación / umbral / n/d"
          grep -RniE "NIVEL|nivel|MEDIO|medio|estaci|umbral|n/d|rojo|amarillo|naranja" /tmp/saih.html | head -n 80 || true

          echo "---- EXTRAER TROZO CERCA DE 'Resumen niveles de r' ----"
          # Saca ~120 líneas alrededor de la cabecera del bloque (si existe)
          LINE=$(grep -n "Resumen niveles de" /tmp/saih.html | head -n 1 | cut -d: -f1 || true)
          if [ -n "$LINE" ]; then
            START=$((LINE-40)); if [ "$START" -lt 1 ]; then START=1; fi
            END=$((LINE+120))
            echo "Mostrando lineas $START a $END"
            sed -n "${START},${END}p" /tmp/saih.html || true
          else
            echo "No encontre 'Resumen niveles de' literal en el HTML."
          fi

          echo "---- LISTAR <script src=...> ----"
          # Extrae URLs de scripts externos
          grep -oP '<script[^>]+src="\K[^"]+' /tmp/saih.html | sed 's/&amp;/\&/g' | sort -u | tee /tmp/scripts.txt || true
          echo "Total scripts externos:"
          wc -l /tmp/scripts.txt || true

          echo "---- DESCARGAR SCRIPTS Y BUSCAR ENDPOINTS ----"
          mkdir -p /tmp/js
          i=0
          while IFS= read -r S; do
            [ -z "$S" ] && continue
            i=$((i+1))
            echo "SCRIPT $i: $S"
            # Descarga (si falla, sigue)
            curl -L "$S" -o "/tmp/js/script_$i.js" || true
          done < /tmp/scripts.txt

          echo "---- GREP ENDPOINTS EN JS ----"
          grep -RniE "api|/json|\\.json|ajax|fetch\\(|axios|endpoint|resumen|rios|nivel|estacion" /tmp/js | head -n 200 || true

          echo "---- FIN DEBUG ----"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run generator
        run: |
          python generate_rss.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rss.xml state.json
          git commit -m "Auto-update RSS" || echo "No changes"
          git push
